<html>
  <head>
    <title>COVID-19 Dashboard</title>
    <style>
      label {
        display: block;
      }
      fieldset {
        display: inline-block;
      }
    </style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

      var sourceURLConfirmed = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv';
      var sourceURLDeaths    = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv';
      var sourceURLRecovered = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv';
      var lastUpdatedTime    = 'https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series';

      var sourceURLs = [
        sourceURLConfirmed,
        sourceURLDeaths,
        sourceURLRecovered,
      //  lastUpdatedTime
      ];

      var lineDelimiter = '\n';

      // var sampleArray = [
      //   ['Date', 'Taiwan', 'BC'],
      //   ['2013',  1000,     400],
      //   ['2014',  1170,     460],
      //   ['2015',  660,      1120],
      //   ['2016',  1030,     540]
      // ];
      
      // var sampleData = [
      //   '"Province/State", "Country/Region", "Lat", "Long", "1/22/20", "1/23/20", "1/24/20", ...
      //   ',Taiwan*,23.7,121,1,1,3,3,4,5,...
      //   'British Columbia,Canada,49.2827,-123.1207,0,0,0,0,0,0,1,1,1,1,1,1,1,1,2,2...
      // ];

      // which lines to draw on the graph
      var filters;

      // holds list of checkboxes on the page
      var checkboxes;

      var chartConfirmed;

      // API response data
      var responseTextConfirmed;
      var responseTextDeaths;
      var responseTextRecovered;

      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(init);

      /*
       * CSV files can have commas inside of quotes so we want to make sure we
       * account for that when splitting.
       */
      function columnSplit(string){
        return CSVtoArray(string);
      }

      // https://stackoverflow.com/a/8497474
      //
      // Return array of string values, or NULL if CSV string not well formed.
      function CSVtoArray(text) {
        var re_valid = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
        var re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
        // Return NULL if input string is not well formed CSV string.
        if (!re_valid.test(text)) return null;
        var a = [];                     // Initialize array to receive values.
        text.replace(re_value, // "Walk" the string using replace with callback.
          function(m0, m1, m2, m3) {
            // Remove backslash from \' in single quoted values.
            if      (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
            // Remove backslash from \" in double quoted values.
            else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
            else if (m3 !== undefined) a.push(m3);
            return ''; // Return empty string.
          });
        // Handle special case of empty last value.
        if (/,\s*$/.test(text)) a.push('');
        return a;
      };

      function getLabel(string){
        var parts = columnSplit(string)
        return parts[0] + ' ' + parts[1];
      }

      function filterRows(row){
        for (var i = 0; i < filters.length; i++){
          var filter = filters[i];
          if (row.indexOf(filter) > -1){
            return true;
          }
        }
      }

      function calculateFilters(){
          filters = [];
          checkboxes.forEach(input => {if (input.checked){ filters.push(input.value)}});
      }

      function inputChanged(event){
        if (responseTextConfirmed){
          console.log( 'input', event.target.value );

          calculateFilters();
          drawCharts();
        }
      }

      function init(){
        // watch for changes in text inputs
        checkboxes = document.querySelectorAll( 'input' );
        checkboxes.forEach(input => input.addEventListener( 'input', inputChanged ));

        // calculate the initial filters
        calculateFilters();

        // get the raw data
        fetchData();
      }

      function fetchData(){
        console.log( 'Fetching data...' );

        // go get all the data from the network
        Promise.all(sourceURLs.map(url => fetch(url)))
        .then(resp => Promise.all( resp.map(r => r.text()) ))
        .then(result => {
          console.log( 'Complete' );
          responseTextConfirmed = result[0];
          responseTextDeaths = result[1];
          responseTextRecovered = result[2];

          chartConfirmed = new google.visualization.AreaChart(document.getElementById('chart-confirmed'));
          chartDeaths = new google.visualization.AreaChart(document.getElementById('chart-deaths'));
          chartRecovered = new google.visualization.AreaChart(document.getElementById('chart-recovered'));
          
          drawCharts();
        })
        .catch(function (err) {
          console.error('Error:', err);
          alert('There was an error fetching data');
        });
      }

      function getChartArray(responseText){
        var rows = responseText.split(lineDelimiter);
        var headerRow = rows[0];
        var dataRows = rows.slice(1); // remove the header row
        var columnHeaders = columnSplit(headerRow);
        var numIgnoredColumns = 4; // the state/region/lat/long columns should be ignored when dealing with the raw data columns
        
        // which rows we want to graph as lines
        var targetRows = dataRows.filter(filterRows);

        // transpose this data into a format Google Charts is expecting...

        var workingArray = [];
        var numLines = targetRows.length;
        var numPoints = columnHeaders.length - numIgnoredColumns;

        workingArray[0] = ['Date'];

        // get the column labels
        for (var i = 0; i < numLines; i++){
          workingArray[0].push(getLabel(targetRows[i]));
        }

        for (var i = 0; i < numPoints; i++){
          var pointArray = [];

          // label
          pointArray.push( columnHeaders[i+numIgnoredColumns]);

          for (var j = 0; j < numLines; j++){
            var targetRowPoints = columnSplit(targetRows[j]);
            pointArray.push( parseInt(targetRowPoints[i+numIgnoredColumns]) );
          }

          workingArray.push(pointArray);
        }
        return workingArray;
      }

      function drawCharts(){
          var defaultOptions = {
            title: 'Chart',
            hAxis: {title: 'Day', titleTextStyle: {color: '#333'}},
            vAxis: {minValue: 0},
            animation: {
              startup: true
            }
          }

          chartConfirmed.draw(google.visualization.arrayToDataTable(getChartArray(responseTextConfirmed)),
                              Object.assign({}, defaultOptions, { title: 'Confirmed Cases Over Time'}));

          chartDeaths.draw(google.visualization.arrayToDataTable(getChartArray(responseTextDeaths)), 
                          Object.assign({}, defaultOptions, { title: 'Deaths Over Time'}));

          chartRecovered.draw(google.visualization.arrayToDataTable(getChartArray(responseTextRecovered)),
                              Object.assign({}, defaultOptions, { title: 'Recovered Cases Over Time'}));
      }
    </script>
  </head>
  <body>
    <h1>COVID-19 Dashboard</h1>

    <h2>Disclaimer</h2>
    <p>Take all data and opinions displayed here with a very large grain of salt. There are bugs and missing information.</p>

    <div>
      <h2>Tips</h2>
      <ul>
        <li>Exceed any government recommendations and pressure them to increase those restrictions. You do not want to play chicken with an exponential graph. A one-day delay can cause 40% more deaths.</li>
        <li>News outlets have poor reporting on this issue. Assume reporters got something wrong or asked the wrong stupid questions and seek underlying sources yourself.</li>
        <li>New York Governor Cuomo has <a href="https://www.youtube.com/watch?v=l3h9Z4u4icM">excellent press conferences</a> that are insightful and direct. You can watch live on YouTube each morning.</li>
        <li>Monitor Johns Hopkins worldwide <a href="https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">case tracker dashboard</a> (if you dare).</li>
      </ul>
    </div>

    <div>
      <h2>Cases over Time</h2>
      <fieldset>
        <legend>Canada</legend>
        <label for="chk-bc"><input type="checkbox" id="chk-bc" value="British Columbia" checked> British Columbia</label>
        <label for="chk-ab"><input type="checkbox" id="chk-ab" value="Alberta" checked> Alberta</label>
        <label for="chk-on"><input type="checkbox" id="chk-on" value="Ontario"> Ontario</label>
        <label for="chk-qb"><input type="checkbox" id="chk-qb" value="Quebec"> Quebec</label>
        <label for="chk-mb"><input type="checkbox" id="chk-mb" value="Manitoba"> Manitoba</label>
        <label for="chk-cd"><input type="checkbox" id="chk-cd" value="Canada"> Canada</label>
      </fieldset>
      <fieldset>
        <legend>USA</legend>
        <label for="chk-ca"><input type="checkbox" id="chk-ca" value="California"> California</label>
        <label for="chk-tt"><input type="checkbox" id="chk-tt" value=", CA"> , CA</label>
        <label for="chk-ny"><input type="checkbox" id="chk-ny" value="New York"> New York</label>
        <label for="chk-wa"><input type="checkbox" id="chk-wa" value="Washington"> Washington</label>
        <label for="chk-fl"><input type="checkbox" id="chk-fl" value="Florida"> Florida</label>
        <label for="chk-tx"><input type="checkbox" id="chk-tx" value="Texas"> Texas</label>
      </fieldset>
      <fieldset>
        <legend>Europe</legend>
        <label for="chk-it"><input type="checkbox" id="chk-it" value="Italy"> Italy</label>
        <label for="chk-fr"><input type="checkbox" id="chk-fr" value="France"> France</label>
        <label for="chk-de"><input type="checkbox" id="chk-de" value="Germany"> Germany</label>
        <label for="chk-sp"><input type="checkbox" id="chk-sp" value="Spain"> Spain</label>
        <label for="chk-uk"><input type="checkbox" id="chk-uk" value="United Kingdom"> United Kingdom</label>
        <label for="chk-es"><input type="checkbox" id="chk-es" value="Estonia"> Estonia</label>
      </fieldset>
      <fieldset>
        <legend>Asia</legend>
        <label for="chk-tw"><input type="checkbox" id="chk-tw" value="Taiwan" checked> Taiwan</label>
        <label for="chk-cn"><input type="checkbox" id="chk-cn" value="China"> China</label>
        <label for="chk-ks"><input type="checkbox" id="chk-ks" value="Korea, South"> Korea, South</label>
        <label for="chk-jp"><input type="checkbox" id="chk-jp" value="Japan"> Japan</label>
        <label for="chk-ru"><input type="checkbox" id="chk-ru" value="Russia"> Russia</label>
        <label for="chk-au"><input type="checkbox" id="chk-au" value="Australia"> Australia</label>
      </fieldset>
    </div>

    <div id="chart-confirmed" style="width: 100%; height: 600px;"></div>
    <div id="chart-deaths" style="width: 100%; height: 600px;"></div>
    <div id="chart-recovered" style="width: 100%; height: 600px;"></div>

    <p>Source: <a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series">Johns Hopkins Center for Systems Science and Engineering</a></p>
    <p>Data is updated once a day typically around 6pm Pacific Time. See <a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data">GitHub</a> for latest commit time.</p>

    <h2>Impact Estimations</h2>

    <p>TODO: Build an estimate algorithm for ICU beds vs. capacity for a region</p>

  </body>
</html>
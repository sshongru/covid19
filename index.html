<html>
  <head>
    <title>COVID-19 Dashboard</title>
    <style>
      label {
        display: block;
      }
      fieldset {
        display: inline-block;
      }
      .population {
        color: rgba(0,0,0,0.25);
      }
    </style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

      var sourceURLConfirmed = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv';
      var sourceURLDeaths    = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv';
      var sourceURLRecovered = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv';
      var lastUpdatedTime    = 'https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series';

      var sourceURLs = [
        sourceURLConfirmed,
        sourceURLDeaths,
        sourceURLRecovered,
      //  lastUpdatedTime
      ];

      var lineDelimiter = '\n';

      // var sampleArray = [
      //   ['Date', 'Taiwan', 'BC'],
      //   ['2013',  1000,     400],
      //   ['2014',  1170,     460],
      //   ['2015',  660,      1120],
      //   ['2016',  1030,     540]
      // ];
      
      // var sampleData = [
      //   '"Province/State", "Country/Region", "Lat", "Long", "1/22/20", "1/23/20", "1/24/20", ...
      //   ',Taiwan*,23.7,121,1,1,3,3,4,5,...
      //   'British Columbia,Canada,49.2827,-123.1207,0,0,0,0,0,0,1,1,1,1,1,1,1,1,2,2...
      // ];

      // which lines to draw on the graph
      var filters;

      // holds list of checkboxes on the page
      var checkboxes;

      var chartConfirmed;

      // API response data
      var responseTextConfirmed;
      var responseTextDeaths;
      var responseTextRecovered;

      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(init);

      /*
       * CSV files can have commas inside of quotes so we want to make sure we
       * account for that when splitting.
       */
      function columnSplit(string){
        return CSVtoArray(string);
      }

      // https://stackoverflow.com/a/8497474
      //
      // Return array of string values, or NULL if CSV string not well formed.
      function CSVtoArray(text) {
        var re_valid = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
        var re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
        // Return NULL if input string is not well formed CSV string.
        if (!re_valid.test(text)) return null;
        var a = [];                     // Initialize array to receive values.
        text.replace(re_value, // "Walk" the string using replace with callback.
          function(m0, m1, m2, m3) {
            // Remove backslash from \' in single quoted values.
            if      (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
            // Remove backslash from \" in double quoted values.
            else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
            else if (m3 !== undefined) a.push(m3);
            return ''; // Return empty string.
          });
        // Handle special case of empty last value.
        if (/,\s*$/.test(text)) a.push('');
        return a;
      };

      function getLabel(string){
        var parts = columnSplit(string)
        return parts[0] + ' ' + parts[1];
      }

      function filterRows(row){
        for (var i = 0; i < filters.length; i++){
          var filter = filters[i];
          if (row.indexOf(filter) > -1){
            return true;
          }
        }
      }

      function calculateFilters(){
          filters = [];
          checkboxes.forEach(input => {if (input.checked){ filters.push(input.value)}});
      }

      function inputChanged(event){
        if (responseTextConfirmed){
          console.log( 'input', event.target.value );

          calculateFilters();
          drawCharts();
        }
      }

      function init(){
        // watch for changes in text inputs
        checkboxes = document.querySelectorAll( 'input' );
        checkboxes.forEach(input => input.addEventListener( 'input', inputChanged ));

        // calculate the initial filters
        calculateFilters();

        // get the raw data
        fetchData();
      }

      function fetchData(){
        console.log( 'Fetching data...' );

        // go get all the data from the network
        Promise.all(sourceURLs.map(url => fetch(url)))
        .then(resp => Promise.all( resp.map(r => r.text()) ))
        .then(result => {
          console.log( 'Complete' );
          responseTextConfirmed = result[0];
          responseTextDeaths = result[1];
          responseTextRecovered = result[2];

          chartConfirmed = new google.visualization.AreaChart(document.getElementById('chart-confirmed'));
          chartDeaths = new google.visualization.AreaChart(document.getElementById('chart-deaths'));
          chartRecovered = new google.visualization.AreaChart(document.getElementById('chart-recovered'));

          drawCharts();
        })
        .catch(function (err) {
          console.error('Error:', err);
          alert('There was an error fetching data');
        });
      }

      function getChartArray(responseText){
        var rows = responseText.split(lineDelimiter);
        var headerRow = rows[0];
        var dataRows = rows.slice(1); // remove the header row
        var columnHeaders = columnSplit(headerRow);
        var numIgnoredColumns = 4; // the state/region/lat/long columns should be ignored when dealing with the raw data columns
        
        // which rows we want to graph as lines
        var targetRows = dataRows.filter(filterRows);

        // transpose this data into a format Google Charts is expecting...

        var workingArray = [];
        var numLines = targetRows.length;
        var numPoints = columnHeaders.length - numIgnoredColumns;

        workingArray[0] = ['Date'];

        // get the column labels
        for (var i = 0; i < numLines; i++){
          workingArray[0].push(getLabel(targetRows[i]));
        }

        for (var i = 0; i < numPoints; i++){
          var pointArray = [];

          // label
          pointArray.push( columnHeaders[i+numIgnoredColumns]);

          for (var j = 0; j < numLines; j++){
            var targetRowPoints = columnSplit(targetRows[j]);
            pointArray.push( parseInt(targetRowPoints[i+numIgnoredColumns]) );
          }

          workingArray.push(pointArray);
        }
        return workingArray;
      }

      function drawCharts(){
          var defaultOptions = {
            title: 'Chart',
            hAxis: {title: 'Day', titleTextStyle: {color: '#333'}},
            vAxis: {minValue: 0},
            animation: {
              duration: 1000,
              easing: 'inAndOut',
              startup: true
            }
          }

          chartConfirmed.draw(google.visualization.arrayToDataTable(getChartArray(responseTextConfirmed)),
                              Object.assign({}, defaultOptions, { title: 'Confirmed Cases Over Time'}));

          chartDeaths.draw(google.visualization.arrayToDataTable(getChartArray(responseTextDeaths)), 
                          Object.assign({}, defaultOptions, { title: 'Deaths Over Time'}));

          chartRecovered.draw(google.visualization.arrayToDataTable(getChartArray(responseTextRecovered)),
                              Object.assign({}, defaultOptions, { title: 'Recovered Cases Over Time'}));
      }
    </script>
  </head>
  <body>
    <h1>COVID-19 Dashboard</h1>

    <h2>Disclaimer</h2>
    <p>Take all data and opinions displayed here with a very large grain of salt. There are bugs and missing information.</p>

    <div>
      <h2>Tips</h2>
      <ul>
        <li>Exceed any government recommendations and pressure them to increase those restrictions. You do not want to play chicken with an exponential graph. A one-day delay can cause 40% more deaths.</li>
        <li>News outlets have poor reporting on this issue. Assume reporters got something wrong or asked the wrong stupid questions and seek underlying sources yourself.</li>
        <li>New York Governor Cuomo has <a href="https://www.youtube.com/watch?v=l3h9Z4u4icM">excellent press conferences</a> that are insightful and direct. You can watch live on YouTube each morning.</li>
        <li>Monitor Johns Hopkins worldwide <a href="https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">case tracker dashboard</a> for a current macro view.</li>
      </ul>
    </div>

    <div>
      <h2>Cases Over Time</h2>
      <fieldset>
        <legend>Canada <span class="population">(37.6M)</span></legend>
        <label for="chk-bc"><input type="checkbox" id="chk-bc" value="British Columbia" checked> British Columbia <span class="population">(5.1M)</span></label>
        <label for="chk-ab"><input type="checkbox" id="chk-ab" value="Alberta" checked> Alberta <span class="population">(4.4M)</span></label>
        <label for="chk-on"><input type="checkbox" id="chk-on" value="Ontario"> Ontario <span class="population">(14.7M)</span></label>
        <label for="chk-qb"><input type="checkbox" id="chk-qb" value="Quebec"> Quebec <span class="population">(8.5M)</span></label>
        <label for="chk-mb"><input type="checkbox" id="chk-mb" value="Manitoba"> Manitoba <span class="population">(1.4M)</span></label>
        <label for="chk-sk"><input type="checkbox" id="chk-sk" value="Saskatchewan"> Saskatchewan <span class="population">(1.2M)</span></label>
        <label for="chk-ns"><input type="checkbox" id="chk-ns" value="Nova Scotia"> Nova Scotia <span class="population">(1.0M)</span></label>
        <label for="chk-nb"><input type="checkbox" id="chk-nb" value="New Brunswick"> New Brunswick <span class="population">(0.8M)</span></label>
        <label for="chk-pe"><input type="checkbox" id="chk-pe" value="Prince Edward Island"> Prince Edward Island <span class="population">(0.2M)</span></label>
        <label for="chk-nf"><input type="checkbox" id="chk-nf" value="Newfoundland"> Newfoundland <span class="population">(0.5M)</span></label>
        <label for="chk-nt"><input type="checkbox" id="chk-nt" value="Northwest Territories"> Northwest Territories <span class="population">(0.04M)</span></label>
      </fieldset>
      <fieldset>
        <legend>USA <span class="population">(327.2M)</span></legend>
        <label for="chk-ca"><input type="checkbox" id="chk-ca" value="California"> California <span class="population">(39.6M)</span></label>
        <label for="chk-tt"><input type="checkbox" id="chk-tt" value=", CA"> Cal. regional (old) <span class="population">(39.6M)</span></label>
        <label for="chk-ny"><input type="checkbox" id="chk-ny" value="New York"> New York <span class="population">(19.5M)</span></label>
        <label for="chk-wa"><input type="checkbox" id="chk-wa" value="Washington"> Washington <span class="population">(7.5M)</span></label>
        <label for="chk-fl"><input type="checkbox" id="chk-fl" value="Florida"> Florida <span class="population">(21.3M)</span></label>
        <label for="chk-tx"><input type="checkbox" id="chk-tx" value="Texas"> Texas <span class="population">(28.7M)</span></label>
        <label for="chk-il"><input type="checkbox" id="chk-il" value="Illinois"> Illinois <span class="population">(12.7M)</span></label>
        <label for="chk-ma"><input type="checkbox" id="chk-ma" value="Massachusetts"> Massachusetts <span class="population">(6.9M)</span></label>
        <label for="chk-nv"><input type="checkbox" id="chk-nv" value="Nevada"> Nevada <span class="population">(3.0M)</span></label>
        <label for="chk-hi"><input type="checkbox" id="chk-hi" value="Hawaii"> Hawaii <span class="population">(1.4M)</span></label>
        <label for="chk-al"><input type="checkbox" id="chk-al" value="Alaska"> Alaska <span class="population">(0.7M)</span></label>
      </fieldset>
      <fieldset>
        <legend>Europe</legend>
        <label for="chk-it"><input type="checkbox" id="chk-it" value="Italy"> Italy <span class="population">(60.5M)</span></label>
        <label for="chk-fr"><input type="checkbox" id="chk-fr" value="France"> France <span class="population">(67.0M)</span></label>
        <label for="chk-de"><input type="checkbox" id="chk-de" value="Germany"> Germany <span class="population">(82.8M)</span></label>
        <label for="chk-sp"><input type="checkbox" id="chk-sp" value="Spain"> Spain <span class="population">(46.6M)</span></label>
        <label for="chk-uk"><input type="checkbox" id="chk-uk" value="United Kingdom"> United Kingdom <span class="population">(66.4M)</span></label>
        <label for="chk-su"><input type="checkbox" id="chk-su" value="Switzerland"> Switzerland <span class="population">(8.6M)</span></label>
        <label for="chk-ne"><input type="checkbox" id="chk-ne" value="Netherlands"> Netherlands <span class="population">(17.2M)</span></label>
        <label for="chk-es"><input type="checkbox" id="chk-es" value="Estonia"> Estonia <span class="population">(1.3M)</span></label>
      </fieldset>
      <fieldset>
        <legend>Other</legend>
        <label for="chk-tw"><input type="checkbox" id="chk-tw" value="Taiwan" checked> Taiwan <span class="population">(23.8M)</span></label>
        <label for="chk-cn"><input type="checkbox" id="chk-cn" value="China"> China <span class="population">(1,386M)</span></label>
        <label for="chk-ks"><input type="checkbox" id="chk-ks" value="Korea, South"> Korea, South <span class="population">(51.5M)</span></label>
        <label for="chk-jp"><input type="checkbox" id="chk-jp" value="Japan"> Japan <span class="population">(126.8M)</span></label>
        <label for="chk-mo"><input type="checkbox" id="chk-mo" value="Mongolia"> Mongolia <span class="population">(3.1M)</span></label>
        <label for="chk-ir"><input type="checkbox" id="chk-ir" value="Iran"> Iran <span class="population">(81.2M)</span></label>
        <label for="chk-tu"><input type="checkbox" id="chk-tu" value="Turkey"> Turkey <span class="population">(80.8M)</span></label>
        <label for="chk-au"><input type="checkbox" id="chk-au" value="Australia"> Australia <span class="population">(24.6M)</span></label>
      </fieldset>
    </div>

    <div id="chart-confirmed" style="width: 100%; height: 600px;"></div>
    <div id="chart-deaths" style="width: 100%; height: 600px;"></div>
    <div id="chart-recovered" style="width: 100%; height: 600px;"></div>

    <p>Source: <a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series">Johns Hopkins Center for Systems Science and Engineering</a></p>
    <p>Data is updated once a day typically around 6pm Pacific Time. See <a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data">GitHub</a> for latest commit time.</p>

    <h2>Impact Estimations</h2>

    <p>TODO: Build an estimate algorithm for ICU beds vs. capacity for a region</p>

  </body>
</html>